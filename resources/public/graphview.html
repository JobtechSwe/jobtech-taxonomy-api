<!DOCTYPE html>
<meta charset="utf-8">
<style>

  .node circle {
  fill: #fff;
  stroke: steelblue;
  stroke-width: 1.5px;
  }

  .node {
  font: 10px sans-serif;
  }

  .link {
  fill: none;
  stroke: #ccc;
  stroke-width: 1.5px;
  }

</style>
<body>
  <h1>Jobtech Taxonomy Viewer</h1>

  <select id="relation-type" name="relation-type"></select>
  <input id="Render" type="button" value="render" onclick="e=document.getElementById('relation-type'); renderGraph(e.options[e.selectedIndex].value)" />

  <div id="elementSelector">
    <div id="plot"></div>
  </div>

  <script src="/js/d3.v3.min.js"></script>



<!-- --------------------------------------------- -->
<!-- Script to populate the relation type dropdown -->
<!-- --------------------------------------------- -->
    <script>
    let dropdown = document.getElementById('relation-type');
    dropdown.length = 0;

    let defaultOption = document.createElement('option');
    defaultOption.text = 'Choose relation type';

    dropdown.add(defaultOption);
    dropdown.selectedIndex = 0;

    const url = 'http://127.0.0.1:4444/relation/types';

    fetch(url)
      .then(
        function(response) {
            if (response.status !== 200) {
                console.warn('Looks like there was a problem. Status Code: ' +
                             response.status);
                return;
            }

            // Examine the text in the response
            response.json().then(function(data) {
                let option;

    	        for (let i = 0; i < data.length; i++) {
                    option = document.createElement('option');
      	            option.text = data[i];
      	            option.value = data[i];
      	            dropdown.add(option);
    	        }
            });
        }
    )
    .catch(function(err) {
        console.error('Fetch Error -', err);
    });
  </script>



<!-- --------------------------------------------- -->
<!-- Script to render graph                        -->
<!-- --------------------------------------------- -->
  <script>


function recCount(dep, jsonObj) {
    var count = 0;

    if( jsonObj !== null && typeof jsonObj == "object" ) {
        Object.entries(jsonObj).forEach(([key, value]) => {
            count = count + recCount(dep + 1, value);
        });
    } else {
      count = 1;
    }
    return count;
}


function renderGraph(relationType) {

// /clusters.json  main-headline-to-headline /relation/graph?relation-type=hyperonym
//d3.json("hyperonym.json", function (error, clusters) {
d3.json("/relation/graph?relation-type="+relationType, function (error, clusters) {

    // stupidly delete any existing svg
    try {
      d3.select(svg).remove();
    } catch(err) {}
    //alert(JSON.stringify(clusters));
    var width = 1024;
   
    //var height = 400000;
    var height = recCount(0, clusters);
    height = height * 9;

    var cluster = d3.layout.cluster()
      .size([height, width - 200]);

    var diagonal = d3.svg.diagonal()
        .projection(function(d) { return [d.y, d.x]; });

    var nodes = cluster.nodes(clusters),
        links = cluster.links(nodes);

    var svg = d3.select("#plot").append("svg")
        .attr("width", width)
        .attr("height", height)
        .append("g")
        .attr("transform", "translate(40,0)");

    var link = svg.selectAll(".link")
        .data(links)
        .enter().append("path")
        .attr("class", "link")
        .attr("d", diagonal);

    var node = svg.selectAll(".node")
        .data(nodes)
        .enter().append("g")
        .attr("class", "node")
        .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })

    node.append("circle")
        .attr("r", 4.5);

    node.append("text")
        .attr("dx", function(d) { return d.children ? -8 : 8; })
        .attr("dy", 3)
        .style("text-anchor", function(d) { return d.children ? "end" : "start"; })
        .text(function(d) { return d.name; });

    d3.select(self.frameElement).style("height", height + "px");

})
}
  </script>
</body>
